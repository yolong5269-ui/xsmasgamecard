<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b1020" />
  <title>ğŸ„ Christmas Dash</title>
  <style>
    :root{
      --bg1:#071024;
      --glass: rgba(255,255,255,.08);
      --glass2: rgba(255,255,255,.12);
      --txt: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);
      --accent:#ffd166;
      --shadow: rgba(0,0,0,.35);
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }
    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html,body{
      height:100%; margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "PingFang TC","Noto Sans TC", Arial;
      color:var(--txt);
      background: radial-gradient(1200px 600px at 50% -20%, #1a2a5a 0%, var(--bg1) 35%, #050817 100%);
      overflow:hidden;
    }
    .wrap{
      height:100%;
      display:grid;
      grid-template-rows: auto 1fr auto;
      padding: calc(12px + var(--safe-top)) 12px calc(12px + var(--safe-bottom));
      gap: 10px;
      max-width: 980px;
      margin: 0 auto;
    }
    header{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .brand{
      display:flex; flex-direction:column; gap:2px;
      padding:10px 12px;
      background: linear-gradient(180deg, var(--glass2), var(--glass));
      border: 1px solid rgba(255,255,255,.10);
      border-radius:14px;
      box-shadow: 0 8px 20px var(--shadow);
      min-width: 240px;
    }
    .brand .title{ font-weight: 760; letter-spacing:.2px; display:flex; align-items:center; gap:8px;}
    .brand .sub{ font-size: 12px; color: var(--muted); }
    .pillbar{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .pill{
      user-select:none;
      display:flex; align-items:center; gap:8px;
      padding:10px 12px;
      background: linear-gradient(180deg, var(--glass2), var(--glass));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 999px;
      box-shadow: 0 8px 20px var(--shadow);
      font-size: 13px;
      color: var(--muted);
      white-space:nowrap;
    }
    .pill b{ color: var(--txt); font-weight: 800; }
    main{
      position:relative;
      border-radius: 18px;
      overflow:hidden;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 18px 45px rgba(0,0,0,.45);
      min-height: 360px;
    }
    canvas{ width:100%; height:100%; display:block; }
    footer{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      padding: 10px 12px;
      background: linear-gradient(180deg, var(--glass2), var(--glass));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      box-shadow: 0 8px 20px var(--shadow);
    }
    .btnrow{ display:flex; gap:10px; flex-wrap:wrap; }
    button{
      cursor:pointer;
      border: 1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.08));
      color: var(--txt);
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 720;
      letter-spacing:.2px;
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
      user-select:none;
    }
    button:active{ transform: translateY(1px); }
    .ghost{ background: transparent; }
    .accent{ border-color: rgba(255,209,102,.45); }
    .accent span{ color: var(--accent); }
    .hint{ color: var(--muted); font-size: 13px; line-height:1.35; }
    .hint code{ color: var(--txt); background: rgba(255,255,255,.08); padding: 2px 6px; border-radius: 8px; }
    .overlay{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      padding: 18px;
      background: radial-gradient(900px 500px at 50% 0%, rgba(255,255,255,.10) 0%, rgba(0,0,0,.55) 60%, rgba(0,0,0,.66) 100%);
      backdrop-filter: blur(6px);
    }
    .card{
      width:min(560px, 100%);
      background: linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.08));
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 18px;
      box-shadow: 0 25px 70px rgba(0,0,0,.55);
      padding: 18px 16px;
    }
    .card h1{ margin: 0 0 8px; font-size: 22px; letter-spacing:.2px; }
    .card p{ margin: 8px 0; color: var(--muted); }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 12px; }
    .stat{
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 10px 12px;
    }
    .stat .k{ font-size: 12px; color: var(--muted); }
    .stat .v{ font-size: 18px; font-weight: 820; margin-top: 2px; }
    .signature{
      margin-top: 14px;
      padding-top: 12px;
      border-top: 1px dashed rgba(255,255,255,.18);
      color: rgba(255,255,255,.85);
      line-height:1.45;
    }
    .signature .small{ color: var(--muted); font-size: 12px; margin-top: 4px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 14px; }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.09);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--muted);
      font-size: 12px;
    }
    .toast{
      position: absolute;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.55);
      border: 1px solid rgba(255,255,255,.14);
      color: rgba(255,255,255,.92);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 13px;
      box-shadow: 0 18px 45px rgba(0,0,0,.45);
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease, transform .18s ease;
    }
    .toast.show{ opacity: 1; transform: translateX(-50%) translateY(-4px); }
    #introOverlay{
      background: radial-gradient(1000px 600px at 50% -10%, rgba(255,209,102,.16) 0%, rgba(0,0,0,.62) 62%, rgba(0,0,0,.72) 100%);
    }
    .introTitle{ font-size: 26px; font-weight: 860; margin: 0 0 6px; letter-spacing:.3px; }
    .introSub{ margin: 0; color: rgba(255,255,255,.78); line-height: 1.5; }
    .introSig{
      margin-top: 12px;
      color: rgba(255,255,255,.82);
      border-top: 1px dashed rgba(255,255,255,.18);
      padding-top: 10px;
    }
    .introSig .small{ color: rgba(255,255,255,.66); font-size: 12px; margin-top: 4px; }
    @media (max-width: 560px){
      .brand{ min-width: 0; }
      .brand .title{ font-size: 14px; }
      .pill{ font-size: 12px; padding: 9px 10px; }
      footer{ gap: 8px; }
      .hint{ font-size: 12px; }
      .grid2{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="title">ğŸ„ Christmas Dash <span class="badge">30s</span></div>
        <div class="sub">Swipe / â† â†’ ç§»å‹•ï¼Œæ¥ç¦®ç‰© + åˆ†æ•¸ï¼Œæ’åˆ°éšœç¤™ - æ™‚é–“</div>
      </div>
      <div class="pillbar">
        <div class="pill">Score <b id="uiScore">0</b></div>
        <div class="pill">Time <b id="uiTime">30.0</b>s</div>
        <div class="pill">Combo <b id="uiCombo">x1</b></div>
        <div class="pill" id="uiSoundPill">Sound <b id="uiSound">ON</b></div>
      </div>
    </header>

    <main>
      <canvas id="c" aria-label="Christmas game canvas"></canvas>
      <div class="toast" id="toast">å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ âœ…</div>

      <!-- Intro cinematic (2 seconds) -->
      <div class="overlay" id="introOverlay" style="display:none;">
        <div class="card" style="text-align:left;">
          <div class="introTitle">ğŸ„ è–èª•å¿«æ¨‚</div>
          <p class="introSub">Balance &amp; Peace<br>ä¸€ä»½å¯ä»¥ç©çš„è–èª•è³€å¡ã€‚30 ç§’å°éŠæˆ²ï¼Œé»é–‹å°±èƒ½ç©ã€‚</p>
          <div class="introSig">
            <div>â€” å¼˜é¨èˆˆæ¥­æœ‰é™å…¬å¸</div>
            <div class="small">Swipe on phone / â† â†’ on desktop</div>
          </div>
        </div>
      </div>

      <!-- Start overlay -->
      <div class="overlay" id="startOverlay">
        <div class="card">
          <h1>ğŸ Merry Christmas</h1>
          <p>30 ç§’å…§æ¥è¶Šå¤šç¦®ç‰©è¶Šå¥½ï¼Œèº²é–‹å†°å¡Šã€‚æ‰‹æ©Ÿå¯å·¦å³æ»‘ï¼Œé›»è…¦ç”¨ <code>â†</code> <code>â†’</code>ã€‚</p>
          <div class="row">
            <button class="accent" id="btnStart"><span>â–¶</span> é–‹å§‹éŠæˆ²</button>
            <button class="ghost" id="btnToggleSoundStart">ğŸ”Š åˆ‡æ›éŸ³æ•ˆ</button>
          </div>
          <p class="hint">å°å½©è›‹ï¼šé€£çºŒæ¥åˆ°ç¦®ç‰©æœƒå‡ comboï¼Œåˆ†æ•¸åŠ å¾—æ›´å¿«ã€‚</p>
        </div>
      </div>

      <!-- End overlay -->
      <div class="overlay" id="endOverlay" style="display:none;">
        <div class="card">
          <h1>ğŸ„ è–èª•å¿«æ¨‚</h1>
          <p style="margin-top:-4px;color:rgba(255,255,255,.78);">Balance &amp; Peace</p>
          <p>ä½ å®Œæˆäº†é€™ 30 ç§’çš„è–èª•è¡åˆºã€‚</p>

          <div class="grid2">
            <div class="stat">
              <div class="k">Final Score</div>
              <div class="v" id="endScore">0</div>
            </div>
            <div class="stat">
              <div class="k">Best Combo</div>
              <div class="v" id="endCombo">x1</div>
            </div>
          </div>

          <div class="signature">
            <div>â€” å¼˜é¨èˆˆæ¥­æœ‰é™å…¬å¸</div>
            <div class="small">ç¥ä½ è–èª•å¿«æ¨‚ï¼ŒBalance &amp; Peaceã€‚</div>
          </div>

          <div class="row">
            <button class="accent" id="btnRestart"><span>â†»</span> å†ç©ä¸€æ¬¡</button>
            <button class="ghost" id="btnShare">ğŸ“¤ åˆ†äº«åˆ†æ•¸</button>
            <button class="ghost" id="btnToggleSoundEnd">ğŸ”Š åˆ‡æ›éŸ³æ•ˆ</button>
          </div>
          <p class="hint" style="margin-top:10px;">åˆ†äº«æœƒæŠŠæ–‡å­—è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼Œä½ å¯ä»¥ç›´æ¥è²¼åˆ°ç¾¤çµ„æˆ–é™å‹•ã€‚</p>
        </div>
      </div>
    </main>

    <footer>
      <div class="hint">
        æ“ä½œï¼šæ‰‹æ©Ÿ<strong>å·¦å³æ»‘</strong>ï½œé›»è…¦ <code>â†</code><code>â†’</code> ï½œå¯æŒ‰ <code>R</code> é‡é–‹<br>
        ç›®æ¨™ï¼šæ¥ç¦®ç‰© + åˆ†æ•¸ï½œæ’å†°å¡Šæœƒæ‰£æ™‚é–“ï¼ˆåˆ¥ç·Šå¼µï¼Œé‚„æ˜¯å¯ä»¥ç¿»ç›¤ï¼‰
      </div>
      <div class="btnrow">
        <button id="btnPause" class="ghost">â¸ æš«åœ</button>
        <button id="btnReset" class="ghost">ğŸ§¹ é‡ç½®</button>
      </div>
    </footer>
  </div>

  <script>
    const CONFIG = {
      duration: 30.0,
      playerSpeed: 680,
      giftSpawn: 0.55,
      iceSpawn: 0.38,
      baseFall: 220,
      fallJitter: 220,
      giftRadius: 18,
      iceRadius: 20,
      playerRadius: 20,
      comboWindow: 1.3,
      comboMax: 8,
      timePenalty: 1.25,
      timePenaltyMin: 0.35,
      laneAssist: true
    };

    const BRAND = {
      company: 'å¼˜é¨èˆˆæ¥­æœ‰é™å…¬å¸',
      greeting: 'è–èª•å¿«æ¨‚',
      blessing: 'Balance & Peace'
    };

    // Canvas
    const canvas = document.getElementById('c');
    const ctx = canvas.getContext('2d', { alpha: false });

    let W = 800, H = 450;

    function resize(){
      const rect = canvas.getBoundingClientRect();
      const dpr = Math.min(2, window.devicePixelRatio || 1);
      canvas.width = Math.floor(rect.width * dpr);
      canvas.height = Math.floor(rect.height * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
      W = rect.width; H = rect.height;
    }

    const ro = new ResizeObserver(resize);
    ro.observe(canvas);
    window.addEventListener('orientationchange', () => setTimeout(resize, 120));
    window.addEventListener('resize', () => setTimeout(resize, 50));

    // UI
    const uiScore = document.getElementById('uiScore');
    const uiTime = document.getElementById('uiTime');
    const uiCombo = document.getElementById('uiCombo');
    const uiSound = document.getElementById('uiSound');
    const uiSoundPill = document.getElementById('uiSoundPill');

    const introOverlay = document.getElementById('introOverlay');
    const startOverlay = document.getElementById('startOverlay');
    const endOverlay = document.getElementById('endOverlay');
    const endScore = document.getElementById('endScore');
    const endCombo = document.getElementById('endCombo');
    const toast = document.getElementById('toast');

    const btnStart = document.getElementById('btnStart');
    const btnRestart = document.getElementById('btnRestart');
    const btnPause = document.getElementById('btnPause');
    const btnReset = document.getElementById('btnReset');
    const btnShare = document.getElementById('btnShare');
    const btnToggleSoundStart = document.getElementById('btnToggleSoundStart');
    const btnToggleSoundEnd = document.getElementById('btnToggleSoundEnd');

    // Audio (simple WebAudio)
    let audioOn = true;
    let audioCtx = null;

    function ensureAudio(){
      if (!audioCtx){
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      if (audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{});
    }

    function beep(type='good'){
      if (!audioOn) return;
      ensureAudio();
      const t = audioCtx.currentTime;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = 'sine';
      const base = (type==='good') ? 660 : 220;
      o.frequency.setValueAtTime(base, t);
      o.frequency.exponentialRampToValueAtTime(base * (type==='good'?1.25:0.8), t+0.08);
      g.gain.setValueAtTime(0.0001, t);
      g.gain.exponentialRampToValueAtTime(0.08, t+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, t+0.12);
      o.connect(g).connect(audioCtx.destination);
      o.start(t);
      o.stop(t+0.13);
    }

    function toggleSound(){
      audioOn = !audioOn;
      uiSound.textContent = audioOn ? 'ON' : 'OFF';
      uiSoundPill.style.opacity = audioOn ? '1' : '.75';
      beep('good');
    }

    // State
    let running = false;
    let paused = false;
    let tLeft = CONFIG.duration;
    let score = 0;
    let combo = 1;
    let bestCombo = 1;
    let lastGiftAt = -999;

    const player = { x: 0, y: 0, vx: 0 };
    let gifts = [];
    let ices  = [];
    let snow  = [];

    // Input
    let keyL = false, keyR = false;
    let touchActive = false;
    let touchX = 0;

    // Helpers
    function rand(a,b){ return a + Math.random()*(b-a); }
    function clamp(v,a,b){ return Math.max(a, Math.min(b,v)); }

    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add('show');
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=>toast.classList.remove('show'), 1400);
    }

    function updateUI(){
      uiScore.textContent = String(Math.floor(score));
      uiTime.textContent = tLeft.toFixed(1);
      uiCombo.textContent = 'x' + combo;
      uiSound.textContent = audioOn ? 'ON' : 'OFF';
      btnPause.textContent = paused ? 'â–¶ ç¹¼çºŒ' : 'â¸ æš«åœ';
    }

    function resetGame(){
      running = false;
      paused = false;
      tLeft = CONFIG.duration;
      score = 0;
      combo = 1;
      bestCombo = 1;
      lastGiftAt = -999;
      gifts = [];
      ices = [];
      snow = [];

      player.x = W/2;
      player.y = H - 64;
      player.vx = 0;

      const count = Math.floor((W*H)/22000);
      for(let i=0;i<count;i++){
        snow.push({ x: Math.random()*W, y: Math.random()*H, r: rand(0.6,2.2), v: rand(28,86), drift: rand(-18,18) });
      }

      updateUI();
      draw();
    }

    function startGame(){
      running = true;
      paused = false;
      startOverlay.style.display = 'none';
      endOverlay.style.display = 'none';
      lastTs = performance.now();
      requestAnimationFrame(loop);
    }

    function endGame(){
      running = false;
      paused = false;
      endScore.textContent = String(Math.floor(score));
      endCombo.textContent = 'x' + bestCombo;
      endOverlay.style.display = 'flex';
    }

    function spawn(dt){
      const giftChance = 1 - Math.exp(-CONFIG.giftSpawn * dt);
      const iceChance  = 1 - Math.exp(-CONFIG.iceSpawn * dt);

      if (Math.random() < giftChance){
        gifts.push({
          x: rand(24, W-24),
          y: -30,
          r: CONFIG.giftRadius,
          v: CONFIG.baseFall + rand(0, CONFIG.fallJitter),
          w: rand(0.7, 1.1)
        });
      }
      if (Math.random() < iceChance){
        ices.push({
          x: rand(24, W-24),
          y: -30,
          r: CONFIG.iceRadius,
          v: CONFIG.baseFall + rand(20, CONFIG.fallJitter+80),
          spin: rand(-2.2, 2.2),
          a: rand(0, Math.PI*2)
        });
      }
    }

    function collide(a,b){
      const dx = a.x - b.x;
      const dy = a.y - b.y;
      const rr = a.r + b.r;
      return (dx*dx + dy*dy) <= rr*rr;
    }

    function applyCombo(now){
      if (now - lastGiftAt <= CONFIG.comboWindow){
        combo = Math.min(CONFIG.comboMax, combo + 1);
      }else{
        combo = 1;
      }
      bestCombo = Math.max(bestCombo, combo);
      lastGiftAt = now;
    }

    // Rendering
    function drawBackground(){
      const g = ctx.createLinearGradient(0,0,0,H);
      g.addColorStop(0, '#0c1b3a');
      g.addColorStop(0.55, '#071024');
      g.addColorStop(1, '#050817');
      ctx.fillStyle = g;
      ctx.fillRect(0,0,W,H);

      ctx.globalAlpha = 0.10;
      ctx.beginPath();
      ctx.arc(W*0.5, H*0.05, Math.min(W,H)*0.55, 0, Math.PI*2);
      ctx.fillStyle = '#ffd166';
      ctx.fill();
      ctx.globalAlpha = 1;

      ctx.globalAlpha = 0.85;
      ctx.fillStyle = '#05102a';
      ctx.beginPath();
      ctx.moveTo(0, H*0.78);
      ctx.quadraticCurveTo(W*0.25, H*0.70, W*0.5, H*0.78);
      ctx.quadraticCurveTo(W*0.75, H*0.86, W, H*0.78);
      ctx.lineTo(W, H);
      ctx.lineTo(0, H);
      ctx.closePath();
      ctx.fill();
      ctx.globalAlpha = 1;

      ctx.fillStyle = 'rgba(255,255,255,0.08)';
      ctx.fillRect(0, H*0.84, W, H*0.16);

      const y = 34;
      ctx.strokeStyle = 'rgba(255,255,255,0.18)';
      ctx.lineWidth = 2;
      ctx.beginPath();
      for(let i=0;i<=12;i++){
        const x = (W/12)*i;
        const yy = y + Math.sin(i*0.8)*6;
        if(i===0) ctx.moveTo(x,yy); else ctx.lineTo(x,yy);
      }
      ctx.stroke();

      for(let i=0;i<12;i++){
        const x = (W/12)*i + (W/24);
        const yy = y + Math.sin((i+0.5)*0.8)*6;
        ctx.beginPath();
        ctx.arc(x, yy+8, 5, 0, Math.PI*2);
        ctx.fillStyle = i%3===0 ? 'rgba(255,209,102,.85)' : (i%3===1 ? 'rgba(122,229,130,.85)' : 'rgba(255,93,108,.85)');
        ctx.fill();
      }
    }

    function drawSnow(dt){
      for(const s of snow){
        s.y += s.v * dt;
        s.x += s.drift * dt;
        if(s.y > H+8){ s.y = -8; s.x = Math.random()*W; }
        if(s.x < -10) s.x = W+10;
        if(s.x > W+10) s.x = -10;
      }

      ctx.fillStyle = 'rgba(255,255,255,0.75)';
      for(const s of snow){
        ctx.globalAlpha = 0.35 + (s.r/2.2)*0.65;
        ctx.beginPath();
        ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
        ctx.fill();
      }
      ctx.globalAlpha = 1;
    }

    function drawPlayer(){
      const x = player.x, y = player.y;
      ctx.save();
      ctx.translate(x,y);

      ctx.globalAlpha = 0.25;
      ctx.fillStyle = '#000';
      ctx.beginPath();
      ctx.ellipse(0, 22, 26, 10, 0, 0, Math.PI*2);
      ctx.fill();
      ctx.globalAlpha = 1;

      ctx.fillStyle = 'rgba(255,255,255,0.92)';
      ctx.strokeStyle = 'rgba(255,255,255,0.35)';
      ctx.lineWidth = 2;

      ctx.beginPath();
      ctx.arc(0, 8, 18, 0, Math.PI*2);
      ctx.fill(); ctx.stroke();

      ctx.beginPath();
      ctx.arc(0, -14, 13, 0, Math.PI*2);
      ctx.fill(); ctx.stroke();

      ctx.fillStyle = 'rgba(10,15,35,0.9)';
      ctx.beginPath();
      ctx.arc(-4, -16, 1.8, 0, Math.PI*2);
      ctx.arc( 4, -16, 1.8, 0, Math.PI*2);
      ctx.fill();

      ctx.fillStyle = 'rgba(255,147,64,0.95)';
      ctx.beginPath();
      ctx.moveTo(0, -13);
      ctx.lineTo(10, -10);
      ctx.lineTo(0, -9);
      ctx.closePath();
      ctx.fill();

      ctx.fillStyle = 'rgba(255,93,108,0.85)';
      ctx.beginPath();
      ctx.roundRect(-13, -3, 26, 7, 5);
      ctx.fill();
      ctx.beginPath();
      ctx.roundRect(4, 1, 7, 14, 5);
      ctx.fill();

      ctx.fillStyle = 'rgba(10,15,35,0.6)';
      ctx.beginPath();
      ctx.arc(0, 2, 1.6, 0, Math.PI*2);
      ctx.arc(0, 9, 1.6, 0, Math.PI*2);
      ctx.fill();

      ctx.restore();
    }

    function drawGift(g){
      const x=g.x, y=g.y;
      ctx.save();
      ctx.translate(x,y);
      const wob = Math.sin((performance.now()/180)*g.w)*0.12;
      ctx.rotate(wob);

      ctx.fillStyle = 'rgba(255,209,102,0.95)';
      ctx.strokeStyle = 'rgba(0,0,0,0.15)';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.roundRect(-14, -14, 28, 28, 6);
      ctx.fill(); ctx.stroke();

      ctx.fillStyle = 'rgba(122,229,130,0.95)';
      ctx.beginPath();
      ctx.roundRect(-3, -14, 6, 28, 3);
      ctx.roundRect(-14, -3, 28, 6, 3);
      ctx.fill();

      ctx.fillStyle = 'rgba(255,93,108,0.95)';
      ctx.beginPath();
      ctx.ellipse(-5, -16, 6, 4, -0.4, 0, Math.PI*2);
      ctx.ellipse( 5, -16, 6, 4,  0.4, 0, Math.PI*2);
      ctx.fill();

      ctx.globalAlpha = 0.18;
      ctx.fillStyle = '#ffd166';
      ctx.beginPath();
      ctx.arc(0,0, 28, 0, Math.PI*2);
      ctx.fill();

      ctx.restore();
      ctx.globalAlpha = 1;
    }

    function drawIce(o){
      const x=o.x, y=o.y;
      ctx.save();
      ctx.translate(x,y);
      ctx.rotate(o.a);
      ctx.fillStyle = 'rgba(180,210,255,0.85)';
      ctx.strokeStyle = 'rgba(255,255,255,0.25)';
      ctx.lineWidth = 2;

      ctx.beginPath();
      ctx.moveTo(-14, -2);
      ctx.lineTo(-4, -14);
      ctx.lineTo(12, -10);
      ctx.lineTo(16, 6);
      ctx.lineTo(2, 16);
      ctx.lineTo(-14, 10);
      ctx.closePath();
      ctx.fill(); ctx.stroke();

      ctx.globalAlpha = 0.18;
      ctx.fillStyle = '#9fd3ff';
      ctx.beginPath();
      ctx.arc(0,0, 26, 0, Math.PI*2);
      ctx.fill();

      ctx.restore();
      ctx.globalAlpha = 1;
    }

    function drawHUDHint(){
      ctx.save();
      ctx.globalAlpha = 0.35;
      ctx.fillStyle = 'rgba(255,255,255,0.8)';
      ctx.font = '12px ui-sans-serif, system-ui';
      ctx.fillText(`${BRAND.greeting} Â· ${BRAND.blessing} â€” ${BRAND.company}`, 14, H - 14);
      ctx.restore();
    }

    function draw(dt=0){
      drawBackground();
      drawSnow(dt);
      for(const g of gifts) drawGift(g);
      for(const o of ices) drawIce(o);
      drawPlayer();
      drawHUDHint();

      if (paused && running){
        ctx.save();
        ctx.globalAlpha = 0.55;
        ctx.fillStyle = '#000';
        ctx.fillRect(0,0,W,H);
        ctx.globalAlpha = 1;
        ctx.fillStyle = 'rgba(255,255,255,0.92)';
        ctx.font = '800 22px ui-sans-serif, system-ui';
        ctx.fillText('æš«åœä¸­', W/2 - 38, H/2 - 6);
        ctx.fillStyle = 'rgba(255,255,255,0.75)';
        ctx.font = '14px ui-sans-serif, system-ui';
        ctx.fillText('æŒ‰ã€Œæš«åœã€æˆ–ç©ºç™½éµç¹¼çºŒ', W/2 - 92, H/2 + 18);
        ctx.restore();
      }
    }

    // Loop
    let lastTs = 0;

    function loop(ts){
      if (!running) return;
      const dt = Math.min(0.033, (ts - lastTs) / 1000);
      lastTs = ts;

      if (!paused){
        tLeft -= dt;
        if (tLeft <= 0){
          tLeft = 0;
          updateUI();
          draw(dt);
          endGame();
          return;
        }

        let dir = 0;
        if (keyL) dir -= 1;
        if (keyR) dir += 1;

        if (touchActive){
          const dx = touchX - player.x;
          dir += clamp(dx / 120, -1, 1);
        }

        player.vx = dir * CONFIG.playerSpeed;
        player.x += player.vx * dt;
        player.x = clamp(player.x, 24, W-24);

        spawn(dt);

        for(const g of gifts){
          g.y += g.v * dt;
          if (CONFIG.laneAssist){
            const dx = player.x - g.x;
            const dy = (player.y - g.y);
            if (Math.abs(dx) < 70 && dy > -30 && dy < 140){
              g.x += clamp(dx, -120, 120) * 0.0032;
            }
          }
        }
        for(const o of ices){
          o.y += o.v * dt;
          o.a += o.spin * dt;
        }

        const now = ts/1000;

        for(let i=gifts.length-1;i>=0;i--){
          const g = gifts[i];
          if (g.y > H+40){ gifts.splice(i,1); continue; }
          if (collide({x:player.x,y:player.y,r:CONFIG.playerRadius},{x:g.x,y:g.y,r:g.r})){
            gifts.splice(i,1);
            applyCombo(now);
            score += (10 * combo);
            beep('good');
          }
        }

        for(let i=ices.length-1;i>=0;i--){
          const o = ices[i];
          if (o.y > H+50){ ices.splice(i,1); continue; }
          if (collide({x:player.x,y:player.y,r:CONFIG.playerRadius},{x:o.x,y:o.y,r:o.r})){
            ices.splice(i,1);
            combo = 1;
            const penalty = Math.max(CONFIG.timePenaltyMin, CONFIG.timePenalty - Math.min(0.9, bestCombo*0.06));
            tLeft = Math.max(0, tLeft - penalty);
            score = Math.max(0, score - 8);
            beep('bad');
          }
        }

        if (now - lastGiftAt > CONFIG.comboWindow){ combo = 1; }

        updateUI();
        draw(dt);
      }else{
        draw(0);
      }

      requestAnimationFrame(loop);
    }

    // Input
    window.addEventListener('keydown', (e)=>{
      const k = e.key.toLowerCase();
      if (k === 'arrowleft') { keyL = true; e.preventDefault(); }
      if (k === 'arrowright'){ keyR = true; e.preventDefault(); }
      if (k === 'r'){ resetGame(); startOverlay.style.display='flex'; endOverlay.style.display='none'; }
      if (k === ' '){ togglePause(); e.preventDefault(); }
      if (k === 'm'){ toggleSound(); }
    }, { passive:false });

    window.addEventListener('keyup', (e)=>{
      const k = e.key.toLowerCase();
      if (k === 'arrowleft') keyL = false;
      if (k === 'arrowright') keyR = false;
    });

    function onTouchStart(ev){
      touchActive = true;
      const t = ev.touches ? ev.touches[0] : ev;
      const rect = canvas.getBoundingClientRect();
      touchX = (t.clientX - rect.left);
      if (audioOn) { try { ensureAudio(); } catch(_){} }
    }
    function onTouchMove(ev){
      const t = ev.touches ? ev.touches[0] : ev;
      const rect = canvas.getBoundingClientRect();
      touchX = (t.clientX - rect.left);
    }
    function onTouchEnd(){ touchActive = false; }

    canvas.addEventListener('touchstart', onTouchStart, { passive:true });
    canvas.addEventListener('touchmove', onTouchMove, { passive:true });
    canvas.addEventListener('touchend', onTouchEnd, { passive:true });
    canvas.addEventListener('mousedown', onTouchStart);
    window.addEventListener('mousemove', (e)=>{ if (touchActive) onTouchMove(e); });
    window.addEventListener('mouseup', onTouchEnd);

    // Buttons
    btnStart.addEventListener('click', ()=>{ resetGame(); startGame(); });
    btnRestart.addEventListener('click', ()=>{ resetGame(); startGame(); });
    btnPause.addEventListener('click', togglePause);
    btnReset.addEventListener('click', ()=>{ resetGame(); startOverlay.style.display='flex'; endOverlay.style.display='none'; });
    btnToggleSoundStart.addEventListener('click', toggleSound);
    btnToggleSoundEnd.addEventListener('click', toggleSound);
    uiSoundPill.addEventListener('click', toggleSound);

    function togglePause(){
      if (!running) return;
      paused = !paused;
      updateUI();
      if (!paused && audioOn){ try { ensureAudio(); } catch(_){} }
    }

    // Share
    async function shareScore(){
      const s = Math.floor(score);
      const msg =
`${BRAND.greeting} ğŸ„
${BRAND.blessing}
æˆ‘åœ¨ Christmas Dash å¾—äº† ${s} åˆ†ï¼ˆBest Combo x${bestCombo}ï¼‰ï¼
â€” ${BRAND.company}`;
      try{
        await navigator.clipboard.writeText(msg);
        showToast('å·²è¤‡è£½åˆ†äº«æ–‡å­— âœ…');
        beep('good');
      }catch(err){
        window.prompt('è¤‡è£½é€™æ®µæ–‡å­—åˆ†äº«ï¼š', msg);
      }
    }
    btnShare.addEventListener('click', shareScore);

    // roundRect polyfill
    if (!CanvasRenderingContext2D.prototype.roundRect){
      CanvasRenderingContext2D.prototype.roundRect = function(x,y,w,h,r){
        r = Math.min(r, w/2, h/2);
        this.beginPath();
        this.moveTo(x+r, y);
        this.arcTo(x+w, y, x+w, y+h, r);
        this.arcTo(x+w, y+h, x, y+h, r);
        this.arcTo(x, y+h, x, y, r);
        this.arcTo(x, y, x+w, y, r);
        this.closePath();
        return this;
      };
    }

    // Intro
    function playIntro(){
      introOverlay.style.display = 'flex';
      const skip = () => {
        introOverlay.style.display = 'none';
        introOverlay.removeEventListener('click', skip);
        introOverlay.removeEventListener('touchstart', skip);
      };
      introOverlay.addEventListener('click', skip, { once:true });
      introOverlay.addEventListener('touchstart', skip, { once:true, passive:true });
      setTimeout(()=>{ introOverlay.style.display = 'none'; }, 2000);
    }

    // Boot
    setTimeout(()=>{
      resize();
      resetGame();
      playIntro();
    }, 0);
  </script>
</body>
</html>
